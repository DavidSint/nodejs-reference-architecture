<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Health Checks | Node.JS Reference Architecture</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://nodeshift.dev/nodejs-reference-architecture/operations/healthchecks"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Health Checks | Node.JS Reference Architecture"><meta data-react-helmet="true" name="description" content="Recommended Components"><meta data-react-helmet="true" property="og:description" content="Recommended Components"><link data-react-helmet="true" rel="shortcut icon" href="/nodejs-reference-architecture/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://nodeshift.dev/nodejs-reference-architecture/operations/healthchecks"><link data-react-helmet="true" rel="alternate" href="https://nodeshift.dev/nodejs-reference-architecture/operations/healthchecks" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://nodeshift.dev/nodejs-reference-architecture/operations/healthchecks" hreflang="x-default"><link rel="stylesheet" href="/nodejs-reference-architecture/assets/css/styles.28552db3.css">
<link rel="preload" href="/nodejs-reference-architecture/assets/js/runtime~main.27a4d17c.js" as="script">
<link rel="preload" href="/nodejs-reference-architecture/assets/js/main.4aaaabff.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/nodejs-reference-architecture/"></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/nodejs-reference-architecture/">Node.js Reference Architecture</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Functional components</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Operations</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/distributed-tracing">Distributed Tracing</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/failurehandling">Fault Tolerance</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/nodejs-reference-architecture/operations/healthchecks">Health Checks</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/logging">Logging</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/metrics">Metrics</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Health Checks</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="recommended-components"></a>Recommended Components<a class="hash-link" href="#recommended-components" title="Direct link to heading">#</a></h2><p>We don&#x27;t recommend the use of a module to add health checks to your application. It&#x27;s
best to stick with a minimal implementation for most cases. The tradeoff between the amount
of code you need to add to your application for a minimal implementation versus
the costs of adding a new dependency leads us to recommend adding the code directly.
Examples of how to add this code to your application are provided in the Guidance section.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="guidance"></a>Guidance<a class="hash-link" href="#guidance" title="Direct link to heading">#</a></h2><p>Kubernetes includes built in liveness and readiness monitoring and document
requirements for these endpoints. We recommended following the
kubernetes requirements as they are well defined, broadly used, and make
your application ready for Kubernetes deployment even if you initially use
something else.</p><p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/" target="_blank" rel="noopener noreferrer">Kubernetes liveness and readiness probes</a> offer three different options: Probe type, port and response as described in the
sections which follow.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="probe-type"></a>Probe type<a class="hash-link" href="#probe-type" title="Direct link to heading">#</a></h3><p>We recommend using an HTTP probe type (<code>httpGet</code>). It demonstrates that the HTTP
server is up and responding to requests and is the most commonly used probe
type for services that expose HTTP as part of their function.</p><p>When using a Service Mesh (Istio), there are are potential
issues that you need to address. If you have mutual TLS enabled,
using <code>httpGet</code> probes with Istio requires some specific configuration. Check the Istio
<a href="https://istio.io/docs/ops/configuration/mesh/app-health-check/" target="_blank" rel="noopener noreferrer">guide</a> to see
the options available when using HTTP request. If this configuration is
not practical for your deployment then TCP probes provide less coverage but
are simpler to support.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="port"></a>Port<a class="hash-link" href="#port" title="Direct link to heading">#</a></h3><p>We recommend responding to probes from the same port as the application server.
Its simple, common, and demonstrates that the HTTP server is up and responding
to requests.</p><p>By listening on the same port, it makes it easy to be certain that the container
does not start responding to probes until it is ready to respond with
application traffic.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="response"></a>Response<a class="hash-link" href="#response" title="Direct link to heading">#</a></h3><p>The response does not need to return any data, but status must be <code>200/OK</code>. For
humans, it may be useful to return a minimal response body, such as <code>ok</code>.</p><p>It may be tempting (particularly based on
tutorials available on the web) to do additional internal state checks
or checks on the availability of dependencies.</p><p>For liveness probes in particular
this can often do more harm than good as the end result is the container
being restarted. For example, if a database used by the application is
down, restarting the container in which the Node.js application using that
database runs, is unlikely to help and can hurt but adding the additional
load of continuously restarting containers.</p><p>For readiness probes, there are advanced use cases where it makes sense
for the service to modify its probe states to
participate in container orchestration. For example, stopping responding on
/readyz and allowing active connections to drain on the main port. When these
requirements exist it makes sense to implement a more complete readiness
endpoint. In other cases it is better to stick to the
simple implementation. For example, in the case of a database that is
down, it is better to respond indicating there is a problem with the database
versus failing the readiness check as that results in the loss of the
ability to provided 5xx responses to requests so that the client
knows what&#x27;s wrong.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="endpoints"></a>Endpoints<a class="hash-link" href="#endpoints" title="Direct link to heading">#</a></h3><p>We recommend that you use consistent naming for your endpoints across micro-services. <code>/readyz</code> and <code>/livez</code> are common choices for the endpoints for the readiness and
liveness probes, respectively.</p><p>Any route name can work if it agrees with the probe configuration, but in the
absence of some requirement by the tooling, best to use names that have a
clear relationship to their purpose. <code>/healthz</code> is not clear as to whether it is
liveness or readiness. Because
<a href="https://developers.redhat.com/blog/2020/11/10/you-probably-need-liveness-and-readiness-probes" target="_blank" rel="noopener noreferrer">the differences between them are important</a>,
it&#x27;s best to clarify.</p><p>The &quot;z&quot; at the end of <code>/readyz</code> and <code>/livez</code> are a pattern called &quot;z pages&quot; that
is a pattern used by <a href="https://kubernetes.io/docs/reference/using-api/health-checks/" target="_blank" rel="noopener noreferrer">internal Kubernetes services</a> and has also been adopted by some other projects like <a href="https://opencensus.io/zpages/" target="_blank" rel="noopener noreferrer">OpenCensus</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="frequency-of-checking"></a>Frequency of checking<a class="hash-link" href="#frequency-of-checking" title="Direct link to heading">#</a></h3><p>Since probe states shouldn&#x27;t change once the application is serving traffic,
there is no need for aggressive probe periods. The initial delay for the liveness
probe should be ample enough for application startup. If its too short,
Kubernetes will keep terminating the container before it serves traffic. Since
the only typical reason to not respond to a readiness probe once the application
is up is that the application is exiting on container termination, Kubernetes
will already know that the container is terminating. Excessively frequent
checking here can also be counter productive.</p><p>We recommend that you don&#x27;t specify specific values for your application and
use the cluster defaults unless your application needs more time to
startup (readiness) or to respond to liveness checks when under load.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="example-code-and-configuration"></a>Example code and configuration<a class="hash-link" href="#example-code-and-configuration" title="Direct link to heading">#</a></h3><p>It is easy to add simple endpoints with with pure Express.js,
or your framework of choice. For example with Express:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;express&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Note that when collecting metrics, the management endpoints should be</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// implemented before the instrumentation that collects metrics, so that</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// these endpoints are not counted in the metrics.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/readyz&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> status</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ok&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/livez&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> status</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ok&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// ... rest of app...</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">listen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The kubernetes endpoints exposed by the application have to agree with the probe configuration:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">readinessProbe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /readyz</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3000</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">livenessProbe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /livez</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/nodeshift/nodejs-reference-architecture/docs/operations/healthchecks.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/nodejs-reference-architecture/operations/failurehandling"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Fault Tolerance</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/nodejs-reference-architecture/operations/logging"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Logging Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#recommended-components" class="table-of-contents__link">Recommended Components</a></li><li><a href="#guidance" class="table-of-contents__link">Guidance</a><ul><li><a href="#probe-type" class="table-of-contents__link">Probe type</a></li><li><a href="#port" class="table-of-contents__link">Port</a></li><li><a href="#response" class="table-of-contents__link">Response</a></li><li><a href="#endpoints" class="table-of-contents__link">Endpoints</a></li><li><a href="#frequency-of-checking" class="table-of-contents__link">Frequency of checking</a></li><li><a href="#example-code-and-configuration" class="table-of-contents__link">Example code and configuration</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/nodejs-reference-architecture/assets/js/runtime~main.27a4d17c.js"></script>
<script src="/nodejs-reference-architecture/assets/js/main.4aaaabff.js"></script>
</body>
</html>