"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9172],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=l(n),h=i,m=u["".concat(c,".").concat(h)]||u[h]||d[h]||r;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var l=2;l<r;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},6973:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return c},metadata:function(){return l},toc:function(){return p},default:function(){return u}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],s={sidebar_position:10},c="Static assets",l={unversionedId:"docs/functional-components/static-assets",id:"docs/functional-components/static-assets",isDocsHomePage:!1,title:"Static assets",description:"Strategies",source:"@site/docs/docs/functional-components/static-assets.md",sourceDirName:"docs/functional-components",slug:"/docs/functional-components/static-assets",permalink:"/nodejs-reference-architecture/docs/functional-components/static-assets",editUrl:"https://github.com/nodeshift/nodejs-reference-architecture/docs/docs/functional-components/static-assets.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"Scaling and Multi-threading",permalink:"/nodejs-reference-architecture/docs/functional-components/scaling-multi-threading"},next:{title:"Template Engines (Server Side)",permalink:"/nodejs-reference-architecture/docs/functional-components/template-engines"}},p=[{value:"Strategies",id:"strategies",children:[{value:"Static only content",id:"static-only-content",children:[]},{value:"Application with dynamically growing content (user generated content)",id:"application-with-dynamically-growing-content-user-generated-content",children:[]},{value:"Application with frontend",id:"application-with-frontend",children:[]}]},{value:"Recommended packages",id:"recommended-packages",children:[]},{value:"Guidance",id:"guidance",children:[{value:"Caching",id:"caching",children:[]},{value:"Naming Static Assets",id:"naming-static-assets",children:[]}]}],d={toc:p};function u(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"static-assets"},"Static assets"),(0,r.kt)("h2",{id:"strategies"},"Strategies"),(0,r.kt)("p",null,"There are different strategies when dealing with assets/resources in a Node.js application:"),(0,r.kt)("h3",{id:"static-only-content"},"Static only content"),(0,r.kt)("p",null,"If your application has only client JavaScript, like a Single Page Application (SPA), look no further. You most likely do not need to use Node.js to host the static content. You can use web servers or object storage like ",(0,r.kt)("inlineCode",{parentName:"p"},"nginx"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Apache"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"COS"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"S3"),", etc, and front that system with caching (CDN)."),(0,r.kt)("h3",{id:"application-with-dynamically-growing-content-user-generated-content"},"Application with dynamically growing content (user generated content)"),(0,r.kt)("p",null,"If your application has primarily server logic, but with growing content, consider using Node.js in combination with an external storage system like ",(0,r.kt)("inlineCode",{parentName:"p"},"COS")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"S3"),". For example, if you have a Node.js application for uploading images, instead of saving images to the file system, consider saving images to object storage. This is a more scalable approach compared to saving images on the file system, which can grow beyond the infrastructure."),(0,r.kt)("h3",{id:"application-with-frontend"},"Application with frontend"),(0,r.kt)("p",null,"If your application has client and server logic, then you should consider using Node.js web server (express) with static middleware. It is a best practice to couple your frontend and backend together as a single, deployable artifact. Doing so addresses concerns such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Syncing assets to external environments (CDNs, object storage, etc)"),(0,r.kt)("li",{parentName:"ul"},"Deploying artifact to different environments (because the assets are self contained, no issues with syncing)"),(0,r.kt)("li",{parentName:"ul"},"Able to use same domain for HTTP2")),(0,r.kt)("p",null,"Read futher for additional guidance on using cache-control headers for static assets."),(0,r.kt)("h2",{id:"recommended-packages"},"Recommended packages"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://expressjs.com/en/4x/api.html#express.static"},"express.static"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"express.static")," is part of the Express.js package that allows developers to expose static middlewares.")),(0,r.kt)("h2",{id:"guidance"},"Guidance"),(0,r.kt)("p",null,"For serving static resources on the application, we recommend using ",(0,r.kt)("a",{parentName:"p",href:"https://expressjs.com/en/4x/api.html#express.static"},"express.static")," middleware as it has been widely used and tested in production."),(0,r.kt)("p",null,"When using ",(0,r.kt)("inlineCode",{parentName:"p"},"express.static()")," method, we can serve static resources directly by specifying the folder name where we have stored our static resources."),(0,r.kt)("p",null,"Documentation for the middleware can be found ",(0,r.kt)("a",{parentName:"p",href:"https://expressjs.com/en/4x/api.html#express.static"},"here")),(0,r.kt)("h3",{id:"caching"},"Caching"),(0,r.kt)("p",null,"The static middleware allows caching of static resources via exposed ",(0,r.kt)("a",{parentName:"p",href:"https://www.freecodecamp.org/news/an-in-depth-introduction-to-http-caching-cache-control-vary/"},"caching-headers"),"."),(0,r.kt)("p",null,"Origin servers communicate caching instructions via the header ",(0,r.kt)("inlineCode",{parentName:"p"},"Cache-Control"),". The values of ",(0,r.kt)("inlineCode",{parentName:"p"},"Cache-Control")," are called directives. Example directives include: ",(0,r.kt)("inlineCode",{parentName:"p"},"max-age"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"no-store, no-cache, must-revalidate"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"public, private"),", etc."),(0,r.kt)("p",null,"Freshness control of the resource happens in cache and is based on time. The validation that happens on origin server is based on time and identifiers (ETags). It is important to have ETag header on all HTTP resources (better/stronger than time based header)."),(0,r.kt)("h4",{id:"common-directive-use-cases"},"Common Directive Use Cases"),(0,r.kt)("p",null,"Note: Upstream systems can be picky about interpreting directives for caching. You may have to read documentation for the particular system (Akamai, Fastly, Google CDN, Cloudflare, nginx, varnish) to verify valid directives."),(0,r.kt)("h5",{id:"caching-static-assets-for-a-year"},"Caching static assets for a year"),(0,r.kt)("p",null,"Cache static assets for a year if the filename and contents are uniquely generated"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Cache-Control: public, max-age=31536000\n\n")),(0,r.kt)("p",null,"If ",(0,r.kt)("inlineCode",{parentName:"p"},"Cache-Control")," does not have max-age, it will respect Expires header"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Cache-Control: public\nExpires: Sat, 13 Feb 2022 07:00:00 GMT\n")),(0,r.kt)("h5",{id:"caching-http-resources-only-on-browser"},"Caching HTTP resources only on browser"),(0,r.kt)("p",null,"In some cases, we want to force cache only for the browser and not for CDN or other upstream caches."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Cache-Control: private\n")),(0,r.kt)("h5",{id:"no-caching-allowed"},"No caching allowed"),(0,r.kt)("p",null,"Force upstream to not cache at all. Useful if you need to ensure that an HTTP resource always goes to origin (for example, if the HTTP resource varies due to a cookie and the endpoint is common to all users)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Cache-Control: no-store, no-cache, must-revalidate\n")),(0,r.kt)("h4",{id:"advanced-caching-guidance"},"Advanced Caching Guidance"),(0,r.kt)("p",null,"For more advanced use cases, caching can be controlled independently of the ",(0,r.kt)("inlineCode",{parentName:"p"},"Cache-Control")," headers. Depending on upstream caching system, you can configure ",(0,r.kt)("inlineCode",{parentName:"p"},"Cache-Control")," header from origin to the CDN, and configure a separate set of caching rules for downstream (the browsers)."),(0,r.kt)("p",null,"Say for example your application contains pages/resources that change depending on a user's logged in state. It is important that ",(0,r.kt)("inlineCode",{parentName:"p"},"Cache-Control"),' is not cached on the browser, however we can still cache at the edge and control the "cache key" based on unique identifiers (such as a userId).'),(0,r.kt)("p",null,"This ensures less hits to origin, takes advantage of caching at the edge, and removes the potential for bad user experiences due to aggressively cached pages."),(0,r.kt)("p",null,"If the application contains uniquely different pages/resources from a non-logged in user, you could keep ",(0,r.kt)("inlineCode",{parentName:"p"},"Cache-Control")," with ",(0,r.kt)("inlineCode",{parentName:"p"},"private, max-age=300")," (or max-age as appropriate based on content and session expiration)."),(0,r.kt)("h3",{id:"naming-static-assets"},"Naming Static Assets"),(0,r.kt)("p",null,"If you configured your static middleware to use client side caching please make sure that\nevery modification in your code will be creating resources with different filename."),(0,r.kt)("p",null,"When using bundlers you will explicitly need to generate different filenames every time content changes. If hash is used in filename, caching directives can be set as long as a year."),(0,r.kt)("p",null,"Example for webpack (most popular bundler) can be found ",(0,r.kt)("a",{parentName:"p",href:"https://webpack.js.org/guides/caching"},"here"),"."))}u.isMDXComponent=!0}}]);